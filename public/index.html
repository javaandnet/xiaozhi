<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°æ™ºç‰©è”ç½‘ç›‘æ§å¹³å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .devices-section, .sensors-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.5em;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        .status-online {
            color: #28a745;
            font-weight: bold;
        }

        .status-offline {
            color: #dc3545;
            font-weight: bold;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background-color: #5a6fd8;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .sensor-data {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .sensor-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .sensor-value {
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }

        .sensor-unit {
            color: #666;
            text-align: center;
        }

        .refresh-btn {
            background-color: #17a2b8;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            float: right;
        }

        .refresh-btn:hover {
            background-color: #138496;
        }

        .websocket-status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        .status-connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .stats-container {
                grid-template-columns: 1fr 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¤– å°æ™ºç‰©è”ç½‘ç›‘æ§å¹³å°</h1>
            <p>å®æ—¶ç›‘æ§å’Œæ§åˆ¶æ‚¨çš„IoTè®¾å¤‡</p>
        </header>

        <div id="websocketStatus" class="websocket-status status-disconnected">
            WebSocketè¿æ¥çŠ¶æ€: æ–­å¼€è¿æ¥
        </div>

        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-value" id="totalDevices">0</div>
                <div class="stat-label">æ€»è®¾å¤‡æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="onlineDevices">0</div>
                <div class="stat-label">åœ¨çº¿è®¾å¤‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="sensorDataCount">0</div>
                <div class="stat-label">ä¼ æ„Ÿå™¨æ•°æ®</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="serverUptime">--:--:--</div>
                <div class="stat-label">æœåŠ¡å™¨è¿è¡Œæ—¶é—´</div>
            </div>
        </div>

        <div class="devices-section">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 class="section-title">è®¾å¤‡åˆ—è¡¨</h2>
                <button class="refresh-btn" onclick="loadDevices()">åˆ·æ–°è®¾å¤‡</button>
            </div>
            <table id="devicesTable">
                <thead>
                    <tr>
                        <th>è®¾å¤‡ID</th>
                        <th>è®¾å¤‡ç±»å‹</th>
                        <th>IPåœ°å€</th>
                        <th>çŠ¶æ€</th>
                        <th>ç”µæ± </th>
                        <th>ä¿¡å·</th>
                        <th>æœ€ååœ¨çº¿</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="devicesTableBody">
                    <tr>
                        <td colspan="8" style="text-align: center;">åŠ è½½ä¸­...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="sensors-section">
            <h2 class="section-title">å®æ—¶ä¼ æ„Ÿå™¨æ•°æ®</h2>
            <div class="sensor-data" id="sensorDataContainer">
                <!-- ä¼ æ„Ÿå™¨æ•°æ®å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let websocket = null;
        let serverStartTime = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            connectWebSocket();
            loadDevices();
            loadSensorData();
            updateServerUptime();
            
            // æ¯5ç§’æ›´æ–°ä¸€æ¬¡æœåŠ¡å™¨è¿è¡Œæ—¶é—´
            setInterval(updateServerUptime, 5000);
            // æ¯10ç§’è‡ªåŠ¨åˆ·æ–°æ•°æ®
            setInterval(() => {
                loadDevices();
                loadSensorData();
            }, 10000);
        });

        // WebSocketè¿æ¥
        function connectWebSocket() {
            const wsUrl = 'ws://localhost:3000';
            websocket = new WebSocket(wsUrl);

            websocket.onopen = function(event) {
                console.log('WebSocketè¿æ¥å·²å»ºç«‹');
                updateWebSocketStatus(true);
            };

            websocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('æ”¶åˆ°WebSocketæ¶ˆæ¯:', data);
                
                // å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯
                switch(data.type) {
                    case 'sensor_update':
                        updateSensorDisplay(data.data);
                        break;
                    case 'device_status':
                        loadDevices(); // é‡æ–°åŠ è½½è®¾å¤‡åˆ—è¡¨
                        break;
                }
            };

            websocket.onclose = function(event) {
                console.log('WebSocketè¿æ¥å·²å…³é—­');
                updateWebSocketStatus(false);
                // 5ç§’åå°è¯•é‡è¿
                setTimeout(connectWebSocket, 5000);
            };

            websocket.onerror = function(error) {
                console.error('WebSocketé”™è¯¯:', error);
                updateWebSocketStatus(false);
            };
        }

        function updateWebSocketStatus(connected) {
            const statusElement = document.getElementById('websocketStatus');
            if (connected) {
                statusElement.className = 'websocket-status status-connected';
                statusElement.textContent = 'WebSocketè¿æ¥çŠ¶æ€: å·²è¿æ¥';
            } else {
                statusElement.className = 'websocket-status status-disconnected';
                statusElement.textContent = 'WebSocketè¿æ¥çŠ¶æ€: æ–­å¼€è¿æ¥';
            }
        }

        // åŠ è½½è®¾å¤‡åˆ—è¡¨
        async function loadDevices() {
            try {
                const response = await fetch(`${API_BASE}/devices`);
                const data = await response.json();
                
                if (data.success) {
                    updateDeviceStats(data.stats || { total: data.count, online: data.devices.filter(d => d.status === 'online').length });
                    renderDevicesTable(data.devices);
                }
            } catch (error) {
                console.error('åŠ è½½è®¾å¤‡å¤±è´¥:', error);
            }
        }

        // æ›´æ–°è®¾å¤‡ç»Ÿè®¡
        function updateDeviceStats(stats) {
            document.getElementById('totalDevices').textContent = stats.total || 0;
            document.getElementById('onlineDevices').textContent = stats.online || 0;
        }

        // æ¸²æŸ“è®¾å¤‡è¡¨æ ¼
        function renderDevicesTable(devices) {
            const tbody = document.getElementById('devicesTableBody');
            
            if (devices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">æš‚æ— è®¾å¤‡</td></tr>';
                return;
            }

            tbody.innerHTML = devices.map(device => `
                <tr>
                    <td>${device.deviceId || device.clientId}</td>
                    <td>${device.deviceType}</td>
                    <td>${device.ip}</td>
                    <td class="${device.status === 'online' ? 'status-online' : 'status-offline'}">
                        ${device.status === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿'}
                    </td>
                    <td>${device.battery ? device.battery + '%' : '--'}</td>
                    <td>${device.signal ? device.signal + 'dB' : '--'}</td>
                    <td>${formatTime(device.lastSeen)}</td>
                    <td>
                        <div class="controls">
                            <button class="btn-primary" onclick="sendCommand('${device.clientId}', 'get_sensor_data')">è·å–æ•°æ®</button>
                            <button class="btn-success" onclick="sendCommand('${device.clientId}', 'led_on')">LEDå¼€</button>
                            <button class="btn-danger" onclick="sendCommand('${device.clientId}', 'led_off')">LEDå…³</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // åŠ è½½ä¼ æ„Ÿå™¨æ•°æ®
        async function loadSensorData() {
            try {
                const response = await fetch(`${API_BASE}/sensors/realtime?limit=20`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('sensorDataCount').textContent = data.count;
                    renderSensorData(data.data);
                }
            } catch (error) {
                console.error('åŠ è½½ä¼ æ„Ÿå™¨æ•°æ®å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“ä¼ æ„Ÿå™¨æ•°æ®
        function renderSensorData(sensorData) {
            const container = document.getElementById('sensorDataContainer');
            
            // æŒ‰ä¼ æ„Ÿå™¨ç±»å‹åˆ†ç»„
            const groupedData = {};
            sensorData.forEach(item => {
                if (!groupedData[item.sensorType]) {
                    groupedData[item.sensorType] = [];
                }
                groupedData[item.sensorType].push(item);
            });

            // ç”ŸæˆHTML
            container.innerHTML = Object.entries(groupedData).map(([sensorType, data]) => {
                const latest = data[0]; // æœ€æ–°çš„æ•°æ®
                return `
                    <div class="sensor-card">
                        <h3>${getSensorTypeName(sensorType)}</h3>
                        <div class="sensor-value">${latest.value}</div>
                        <div class="sensor-unit">${latest.unit || ''}</div>
                        <div style="text-align: center; color: #666; font-size: 0.9em;">
                            è®¾å¤‡: ${latest.clientId.substring(0, 8)}...<br>
                            æ—¶é—´: ${formatTime(latest.timestamp)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ›´æ–°å•ä¸ªä¼ æ„Ÿå™¨æ˜¾ç¤º
        function updateSensorDisplay(sensorData) {
            // è¿™é‡Œå¯ä»¥å®ç°å®æ—¶æ›´æ–°ç‰¹å®šä¼ æ„Ÿå™¨çš„æ˜¾ç¤º
            loadSensorData(); // ç®€å•èµ·è§ï¼Œé‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®
        }

        // å‘é€å‘½ä»¤åˆ°è®¾å¤‡
        async function sendCommand(clientId, command) {
            try {
                const response = await fetch(`${API_BASE}/devices/${clientId}/command`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ command })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert(`å‘½ä»¤å·²å‘é€: ${command}`);
                } else {
                    alert(`å‘½ä»¤å‘é€å¤±è´¥: ${result.error}`);
                }
            } catch (error) {
                console.error('å‘é€å‘½ä»¤å¤±è´¥:', error);
                alert('å‘é€å‘½ä»¤å¤±è´¥');
            }
        }

        // æ›´æ–°æœåŠ¡å™¨è¿è¡Œæ—¶é—´
        async function updateServerUptime() {
            try {
                const response = await fetch('http://localhost:3000/health');
                const data = await response.json();
                
                if (!serverStartTime) {
                    serverStartTime = new Date(Date.now() - data.uptime * 1000);
                }
                
                const uptime = Math.floor(data.uptime);
                const hours = Math.floor(uptime / 3600);
                const minutes = Math.floor((uptime % 3600) / 60);
                const seconds = uptime % 60;
                
                document.getElementById('serverUptime').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } catch (error) {
                console.error('è·å–æœåŠ¡å™¨çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // å·¥å…·å‡½æ•°
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN');
        }

        function getSensorTypeName(type) {
            const names = {
                'temperature': 'æ¸©åº¦',
                'humidity': 'æ¹¿åº¦',
                'pressure': 'æ°”å‹',
                'light': 'å…‰ç…§',
                'motion': 'è¿åŠ¨æ£€æµ‹'
            };
            return names[type] || type;
        }
    </script>
</body>
</html>