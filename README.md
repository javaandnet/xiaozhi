# å°æ™ºç‰©è”ç½‘åå°æœåŠ¡å™¨

ä¸€ä¸ªåŸºäºNode.jså’ŒWebSocketçš„ç‰©è”ç½‘è®¾å¤‡ç®¡ç†å¹³å°ï¼Œä¸“ä¸ºESP32ç­‰IoTè®¾å¤‡è®¾è®¡ã€‚

## ğŸš€ åŠŸèƒ½ç‰¹æ€§

- **å®æ—¶é€šä¿¡**: åŸºäºWebSocketçš„åŒå‘å®æ—¶é€šä¿¡
- **è®¾å¤‡ç®¡ç†**: è®¾å¤‡æ³¨å†Œã€çŠ¶æ€ç›‘æ§ã€åœ¨çº¿ç»Ÿè®¡
- **ä¼ æ„Ÿå™¨æ•°æ®**: å®æ—¶ä¼ æ„Ÿå™¨æ•°æ®æ”¶é›†å’Œå±•ç¤º
- **è¿œç¨‹æ§åˆ¶**: å‘è®¾å¤‡å‘é€æ§åˆ¶å‘½ä»¤
- **Webç›‘æ§ç•Œé¢**: ç›´è§‚çš„Webç•Œé¢ç›‘æ§æ‰€æœ‰è®¾å¤‡
- **RESTful API**: å®Œæ•´çš„HTTP APIæ¥å£
- **æ—¥å¿—ç³»ç»Ÿ**: è¯¦ç»†çš„è¿è¡Œæ—¥å¿—è®°å½•

## ğŸ“ é¡¹ç›®ç»“æ„

```
xiaozhi/
â”œâ”€â”€ server.js                 # ä¸»æœåŠ¡å™¨æ–‡ä»¶
â”œâ”€â”€ package.json             # é¡¹ç›®ä¾èµ–é…ç½®
â”œâ”€â”€ .env                     # ç¯å¢ƒå˜é‡é…ç½®
â”œâ”€â”€ .env.example            # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ public/                  # å‰ç«¯é™æ€æ–‡ä»¶
â”‚   â””â”€â”€ index.html          # ç›‘æ§ç•Œé¢
â”œâ”€â”€ websocket/              # WebSocketç›¸å…³æ–‡ä»¶
â”‚   â””â”€â”€ handler.js         # WebSocketå¤„ç†å™¨
â”œâ”€â”€ routes/                 # APIè·¯ç”±
â”‚   â”œâ”€â”€ devices.js         # è®¾å¤‡ç®¡ç†è·¯ç”±
â”‚   â””â”€â”€ sensors.js         # ä¼ æ„Ÿå™¨æ•°æ®è·¯ç”±
â”œâ”€â”€ managers/               # ä¸šåŠ¡é€»è¾‘ç®¡ç†å™¨
â”‚   â””â”€â”€ deviceManager.js   # è®¾å¤‡ç®¡ç†å™¨
â”œâ”€â”€ utils/                  # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ logger.js          # æ—¥å¿—å·¥å…·
â”‚   â””â”€â”€ validation.js      # æ•°æ®éªŒè¯å·¥å…·
â”œâ”€â”€ examples/               # ç¤ºä¾‹ä»£ç 
â”‚   â””â”€â”€ esp32_client.ino   # ESP32å®¢æˆ·ç«¯ç¤ºä¾‹
â””â”€â”€ logs/                   # æ—¥å¿—æ–‡ä»¶ç›®å½•
```

## ğŸ”§ å®‰è£…éƒ¨ç½²

### 1. å…‹éš†é¡¹ç›®
```bash
git clone <repository-url>
cd xiaozhi
```

### 2. å®‰è£…ä¾èµ–
```bash
npm install
```

### 3. é…ç½®ç¯å¢ƒå˜é‡
```bash
cp .env.example .env
```

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼Œé…ç½®ç›¸å…³å‚æ•°ï¼š
```env
PORT=3000
HOST=localhost
LOG_LEVEL=debug
```

### 4. å¯åŠ¨æœåŠ¡å™¨
```bash
# å¼€å‘æ¨¡å¼ï¼ˆå¸¦çƒ­é‡è½½ï¼‰
npm run dev

# ç”Ÿäº§æ¨¡å¼
npm start
```

æœåŠ¡å™¨å°†åœ¨ `http://localhost:3000` å¯åŠ¨

## ğŸŒ APIæ¥å£æ–‡æ¡£

### è®¾å¤‡ç®¡ç†æ¥å£

#### è·å–æ‰€æœ‰è®¾å¤‡
```http
GET /api/devices
```

#### è·å–ç‰¹å®šè®¾å¤‡
```http
GET /api/devices/{clientId}
```

#### å‘è®¾å¤‡å‘é€å‘½ä»¤
```http
POST /api/devices/{clientId}/command
Content-Type: application/json

{
  "command": "led_on",
  "payload": {}
}
```

#### è·å–è®¾å¤‡ç»Ÿè®¡
```http
GET /api/devices/stats/overview
```

### ä¼ æ„Ÿå™¨æ•°æ®æ¥å£

#### è·å–ä¼ æ„Ÿå™¨æ•°æ®
```http
GET /api/sensors?sensorType=temperature&limit=50
```

#### è·å–ç‰¹å®šè®¾å¤‡ä¼ æ„Ÿå™¨æ•°æ®
```http
GET /api/sensors/device/{clientId}?sensorType=temperature
```

#### è·å–ä¼ æ„Ÿå™¨ç»Ÿè®¡
```http
GET /api/sensors/stats/temperature?hours=24
```

## ğŸ“± WebSocketåè®®

### å®¢æˆ·ç«¯â†’æœåŠ¡å™¨æ¶ˆæ¯

#### è®¾å¤‡æ³¨å†Œ
```json
{
  "type": "device_register",
  "payload": {
    "deviceId": "esp32_001",
    "deviceType": "sensor_node",
    "capabilities": ["temperature", "humidity", "led_control"]
  }
}
```

#### ä¼ æ„Ÿå™¨æ•°æ®ä¸ŠæŠ¥
```json
{
  "type": "sensor_data",
  "payload": {
    "sensorType": "temperature",
    "value": 25.6,
    "unit": "Â°C",
    "timestamp": "2024-01-01T10:00:00Z"
  }
}
```

#### è®¾å¤‡çŠ¶æ€æ›´æ–°
```json
{
  "type": "device_status",
  "payload": {
    "status": "online",
    "battery": 85,
    "signal": -65
  }
}
```

#### å‘½ä»¤æ‰§è¡Œç»“æœ
```json
{
  "type": "command_response",
  "commandId": "cmd_123456",
  "result": "success",
  "message": "LEDå·²å¼€å¯"
}
```

### æœåŠ¡å™¨â†’å®¢æˆ·ç«¯æ¶ˆæ¯

#### è¿æ¥ç¡®è®¤
```json
{
  "type": "connection_ack",
  "clientId": "client_123456",
  "timestamp": "2024-01-01T10:00:00Z",
  "message": "è¿æ¥æˆåŠŸå»ºç«‹"
}
```

#### è®¾å¤‡æ³¨å†Œç¡®è®¤
```json
{
  "type": "register_ack",
  "deviceId": "esp32_001",
  "timestamp": "2024-01-01T10:00:00Z",
  "message": "è®¾å¤‡æ³¨å†ŒæˆåŠŸ"
}
```

#### æ§åˆ¶å‘½ä»¤
```json
{
  "type": "command",
  "commandId": "cmd_123456",
  "command": "led_on",
  "payload": {},
  "timestamp": "2024-01-01T10:00:00Z"
}
```

#### é”™è¯¯æ¶ˆæ¯
```json
{
  "type": "error",
  "message": "è®¾å¤‡æœªæ‰¾åˆ°",
  "timestamp": "2024-01-01T10:00:00Z"
}
```

## ğŸ¤– ESP32å®¢æˆ·ç«¯é›†æˆ

### Arduinoåº“ä¾èµ–
```cpp
#include <WiFi.h>
#include <WebSocketsClient.h>
#include <ArduinoJson.h>
#include <DHT.h>
```

### åŸºæœ¬è¿æ¥ç¤ºä¾‹
```cpp
WebSocketsClient webSocket;

void setup() {
  // WiFiè¿æ¥
  WiFi.begin("ssid", "password");
  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
  }
  
  // WebSocketè¿æ¥
  webSocket.begin("192.168.1.100", 3000, "/");
  webSocket.onEvent(webSocketEvent);
}

void loop() {
  webSocket.loop();
  // å…¶ä»–é€»è¾‘...
}
```

è¯¦ç»†ç¤ºä¾‹è¯·æŸ¥çœ‹ `examples/esp32_client.ino` æ–‡ä»¶ã€‚

## ğŸ–¥ï¸ Webç›‘æ§ç•Œé¢

è®¿é—® `http://localhost:3000` å³å¯æ‰“å¼€ç›‘æ§ç•Œé¢ï¼ŒåŠŸèƒ½åŒ…æ‹¬ï¼š

- å®æ—¶è®¾å¤‡çŠ¶æ€æ˜¾ç¤º
- ä¼ æ„Ÿå™¨æ•°æ®å¯è§†åŒ–
- è®¾å¤‡è¿œç¨‹æ§åˆ¶
- WebSocketè¿æ¥çŠ¶æ€ç›‘æ§
- è®¾å¤‡ç»Ÿè®¡ä¿¡æ¯

## ğŸ”’ å®‰å…¨è€ƒè™‘

### å½“å‰ç‰ˆæœ¬å®‰å…¨ç‰¹æ€§
- åŸºç¡€çš„è¾“å…¥éªŒè¯
- é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- è¿æ¥çŠ¶æ€ç›‘æ§

### å»ºè®®çš„å®‰å…¨å¢å¼º
- æ·»åŠ APIå¯†é’¥è®¤è¯
- å®ç°JWTä»¤ç‰ŒéªŒè¯
- æ·»åŠ è¯·æ±‚é¢‘ç‡é™åˆ¶
- å¯ç”¨HTTPSæ”¯æŒ
- æ•°æ®åº“è®¿é—®æ§åˆ¶

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### æœåŠ¡å™¨ç«¯ä¼˜åŒ–
- ä½¿ç”¨Redisç¼“å­˜é¢‘ç¹è®¿é—®çš„æ•°æ®
- å®ç°æ•°æ®åº“è¿æ¥æ± 
- æ·»åŠ è´Ÿè½½å‡è¡¡æ”¯æŒ
- å¯ç”¨Gzipå‹ç¼©

### å®¢æˆ·ç«¯ä¼˜åŒ–
- å®ç°æ•°æ®æ‰¹é‡å‘é€
- æ·»åŠ æœ¬åœ°æ•°æ®ç¼“å­˜
- ä¼˜åŒ–WebSocketé‡è¿æœºåˆ¶
- å‡å°‘ä¸å¿…è¦çš„æ•°æ®ä¼ è¾“

## ğŸ› ï¸ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„ä¼ æ„Ÿå™¨ç±»å‹
1. åœ¨éªŒè¯å·¥å…·ä¸­æ·»åŠ ä¼ æ„Ÿå™¨ç±»å‹æ£€æŸ¥
2. æ›´æ–°å‰ç«¯æ˜¾ç¤ºé€»è¾‘
3. æ‰©å±•æ•°æ®å¤„ç†é€»è¾‘

### æ‰©å±•æ§åˆ¶å‘½ä»¤
1. åœ¨WebSocketå¤„ç†å™¨ä¸­æ·»åŠ å‘½ä»¤å¤„ç†é€»è¾‘
2. æ›´æ–°è®¾å¤‡èƒ½åŠ›å®šä¹‰
3. ä¿®æ”¹å‰ç«¯æ§åˆ¶ç•Œé¢

### æ•°æ®æŒä¹…åŒ–
ç›®å‰æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå¦‚éœ€æŒä¹…åŒ–ï¼š
1. é›†æˆMongoDBæˆ–PostgreSQL
2. ä¿®æ”¹DeviceManagerç±»
3. æ·»åŠ æ•°æ®è¿ç§»è„šæœ¬

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**WebSocketè¿æ¥å¤±è´¥**
- æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ
- ç¡®è®¤é˜²ç«å¢™è®¾ç½®
- éªŒè¯ç½‘ç»œè¿æ¥

**è®¾å¤‡æ— æ³•æ³¨å†Œ**
- æ£€æŸ¥è®¾å¤‡IDæ ¼å¼
- ç¡®è®¤ç½‘ç»œå¯è¾¾æ€§
- æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—

**ä¼ æ„Ÿå™¨æ•°æ®ä¸æ›´æ–°**
- éªŒè¯æ•°æ®æ ¼å¼æ­£ç¡®æ€§
- æ£€æŸ¥æ—¶é—´æˆ³æœ‰æ•ˆæ€§
- ç¡®è®¤WebSocketè¿æ¥çŠ¶æ€

### æ—¥å¿—æŸ¥çœ‹
```bash
# æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
tail -f logs/server.log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f logs/error.log
```

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestæ¥æ”¹è¿›é¡¹ç›®ï¼

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š
- æäº¤GitHub Issue
- å‘é€é‚®ä»¶è‡³é¡¹ç›®ç»´æŠ¤è€…

---
*å°æ™ºç‰©è”ç½‘åå°æœåŠ¡å™¨ - è®©IoTè®¾å¤‡ç®¡ç†å˜å¾—æ›´ç®€å•*